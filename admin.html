<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - متجر ابيض و اسود</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: #f8f9fa;
        }
        .sidebar {
            background: #2c3e50;
            min-height: 100vh;
            padding: 20px;
            color: white;
            position: fixed;
            width: 250px;
            transition: all 0.3s ease;
        }
        .sidebar-header {
            padding: 20px 0;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-header img {
            width: 80px;
            margin-bottom: 10px;
        }
        .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            margin: 5px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .nav-link i {
            margin-left: 10px;
        }
        .main-content {
            margin-right: 250px;
            padding: 20px;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        .stat-card {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            border-radius: 15px;
        }
        .stat-card i {
            font-size: 2.5rem;
            opacity: 0.8;
        }
        .stat-card h3 {
            font-size: 2rem;
            margin: 10px 0;
        }
        .stat-card p {
            opacity: 0.8;
            margin: 0;
        }
        .order-card {
            margin-bottom: 20px;
        }
        .order-card .card-header {
            background: #f8f9fa;
            border-bottom: none;
            padding: 15px 20px;
        }
        .order-card .card-body {
            padding: 20px;
        }
        .order-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .order-item:last-child {
            border-bottom: none;
        }
        .order-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            margin-left: 15px;
        }
        .order-item-info {
            flex: 1;
        }
        .order-item-info h6 {
            margin-bottom: 5px;
        }
        .order-item-info p {
            margin: 0;
            color: #666;
        }
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        .status-new {
            background: #e3f2fd;
            color: #1976d2;
        }
        .status-processing {
            background: #fff3e0;
            color: #f57c00;
        }
        .status-completed {
            background: #e8f5e9;
            color: #388e3c;
        }
        .status-cancelled {
            background: #ffebee;
            color: #d32f2f;
        }
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        .search-box input {
            padding-right: 40px;
            border-radius: 20px;
            border: 2px solid #eee;
        }
        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }
        .filter-buttons {
            margin-bottom: 20px;
        }
        .filter-buttons .btn {
            margin-left: 10px;
            border-radius: 20px;
            padding: 8px 20px;
        }
        .pagination {
            justify-content: center;
            margin-top: 20px;
        }
        .pagination .page-link {
            border-radius: 20px;
            margin: 0 5px;
            border: none;
            color: #2c3e50;
        }
        .pagination .page-item.active .page-link {
            background: #2c3e50;
            color: white;
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                min-height: auto;
            }
            .main-content {
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <img src="Logo (1).png" alt="متجر ابيض و اسود">
            <h5>لوحة التحكم</h5>
        </div>
        <nav class="nav flex-column mt-4">
            <a class="nav-link active" href="#">
                <i class="bi bi-house-door"></i>
                الرئيسية
            </a>
            <a class="nav-link" href="#">
                <i class="bi bi-bag"></i>
                الطلبات
            </a>
            <a class="nav-link" href="#">
                <i class="bi bi-people"></i>
                العملاء
            </a>
            <a class="nav-link" href="#">
                <i class="bi bi-box"></i>
                المنتجات
            </a>
            <a class="nav-link" href="#">
                <i class="bi bi-graph-up"></i>
                التقارير
            </a>
            <a class="nav-link" href="#">
                <i class="bi bi-gear"></i>
                الإعدادات
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container-fluid">
            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <i class="bi bi-bag"></i>
                        <h3 id="totalOrders">0</h3>
                        <p>إجمالي الطلبات</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <i class="bi bi-currency-dollar"></i>
                        <h3 id="totalRevenue">0</h3>
                        <p>إجمالي المبيعات</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <i class="bi bi-people"></i>
                        <h3 id="totalCustomers">0</h3>
                        <p>إجمالي العملاء</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <i class="bi bi-box"></i>
                        <h3 id="totalProducts">0</h3>
                        <p>إجمالي المنتجات</p>
                    </div>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="search-box">
                        <input type="text" class="form-control" placeholder="بحث في الطلبات...">
                        <i class="bi bi-search"></i>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="filter-buttons">
                        <button class="btn btn-outline-primary active">الكل</button>
                        <button class="btn btn-outline-primary">جديد</button>
                        <button class="btn btn-outline-primary">قيد المعالجة</button>
                        <button class="btn btn-outline-primary">مكتمل</button>
                        <button class="btn btn-outline-primary">ملغي</button>
                    </div>
                </div>
            </div>

            <!-- Orders List -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">الطلبات الأخيرة</h5>
                        </div>
                        <div class="card-body">
                            <div id="ordersList">
                                <!-- سيتم إضافة الطلبات هنا -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination">
                    <li class="page-item">
                        <a class="page-link" href="#" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                    <li class="page-item">
                        <a class="page-link" href="#" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script>
        // إعدادات Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCSdIbH7AIUknrBhOkB2zjCRuwAUsUL4o8",
            authDomain: "brand-7d188.firebaseapp.com",
            databaseURL: "https://brand-7d188-default-rtdb.firebaseio.com",
            projectId: "brand-7d188",
            storageBucket: "brand-7d188.firebasestorage.app",
            messagingSenderId: "984271643354",
            appId: "1:984271643354:web:e5d7ac7018c0d015d4fbe3",
            measurementId: "G-N0VFC9B4XZ"
        };

        // تهيئة Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const ordersRef = db.ref('orders');

        // تحميل الطلبات وعرضها
        function loadOrders() {
            console.log('جاري تحميل الطلبات...');
            ordersRef.on('value', (snapshot) => {
                console.log('تم استلام البيانات:', snapshot.val());
                const ordersList = document.getElementById('ordersList');
                ordersList.innerHTML = '';
                
                if (!snapshot.exists()) {
                    console.log('لا توجد طلبات في قاعدة البيانات');
                    ordersList.innerHTML = '<div class="text-center text-muted py-4">لا توجد طلبات</div>';
                    return;
                }

                let totalOrders = 0;
                let totalRevenue = 0;
                let customers = new Set();

                // تحويل البيانات إلى مصفوفة وترتيبها حسب التاريخ
                const orders = [];
                snapshot.forEach((childSnapshot) => {
                    const order = childSnapshot.val();
                    if (order) { // التأكد من وجود بيانات الطلب
                        order.id = childSnapshot.key;
                        orders.push(order);
                        console.log('تمت إضافة طلب:', order);
                    }
                });

                if (orders.length === 0) {
                    console.log('لم يتم العثور على طلبات صالحة');
                    ordersList.innerHTML = '<div class="text-center text-muted py-4">لا توجد طلبات</div>';
                    return;
                }

                // ترتيب الطلبات من الأحدث إلى الأقدم
                orders.sort((a, b) => {
                    const dateA = new Date(a.orderDate || 0);
                    const dateB = new Date(b.orderDate || 0);
                    return dateB - dateA;
                });

                orders.forEach(order => {
                    try {
                        totalOrders++;
                        totalRevenue += parseFloat(order.totalAmount) || 0;
                        if (order.customerPhone) {
                            customers.add(order.customerPhone);
                        }

                        // إضافة حالة افتراضية إذا لم تكن موجودة
                        if (!order.status) {
                            order.status = 'جديد';
                        }

                        const orderDiv = document.createElement('div');
                        orderDiv.className = 'order-card card mb-3';
                        orderDiv.innerHTML = `
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="mb-3">معلومات العميل</h6>
                                        <div class="card bg-light mb-3">
                                            <div class="card-body">
                                                <p class="mb-2"><strong>الاسم:</strong> ${order.customerName || 'غير محدد'}</p>
                                                <p class="mb-2"><strong>رقم الهاتف:</strong> ${order.customerPhone || 'غير محدد'}</p>
                                                <p class="mb-2"><strong>العنوان:</strong> ${order.customerAddress || 'غير محدد'}</p>
                                                <p class="mb-2"><strong>تاريخ الطلب:</strong> ${new Date(order.orderDate || Date.now()).toLocaleString('ar-EG')}</p>
                                                <p class="mb-0"><strong>ملاحظات العميل:</strong> ${order.customerNote || 'لا توجد ملاحظات'}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="mb-3">ملخص الطلب</h6>
                                        <div class="card bg-light mb-3">
                                            <div class="card-body">
                                                <p class="mb-2"><strong>رقم الطلب:</strong> #${order.id}</p>
                                                <p class="mb-2"><strong>حالة الطلب:</strong> ${order.status || 'جديد'}</p>
                                                <p class="mb-2"><strong>المجموع الكلي:</strong> ${(order.totalAmount || 0).toLocaleString()} ج.م</p>
                                                ${order.discountCode ? `
                                                    <p class="mb-2"><strong>كود الخصم المستخدم:</strong> ${order.discountCode}</p>
                                                    <p class="mb-2"><strong>قيمة الخصم:</strong> ${(order.totalAmount * 0.10).toLocaleString()} ج.م (10%)</p>
                                                    <p class="mb-2"><strong>المجموع بعد الخصم:</strong> ${(order.totalAmount * 0.90).toLocaleString()} ج.م</p>
                                                ` : `
                                                    <p class="mb-2"><strong>قيمة الخصم:</strong> 0 ج.م</p>
                                                    <p class="mb-2"><strong>المجموع بعد الخصم:</strong> ${(order.totalAmount || 0).toLocaleString()} ج.م</p>
                                                `}
                                                <p class="mb-0"><strong>الكمية الإجمالية:</strong> ${Object.values(order.items || {}).reduce((total, item) => total + (item.quantity || 0), 0)} منتج</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <h6 class="mb-3">تفاصيل المنتجات</h6>
                                    <div class="row">
                                        ${order.items && Object.entries(order.items).map(([itemId, item]) => `
                                            <div class="col-md-6 mb-3">
                                                <div class="card">
                                                    <div class="card-body">
                                                        <div class="d-flex align-items-center">
                                                            <img src="${item.image}" class="product-img me-3" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
                                                            <div>
                                                                <h6 class="mb-1">${item.name}</h6>
                                                                <p class="mb-1 text-muted">السعر: ${item.price.toLocaleString()} ج.م</p>
                                                                <p class="mb-1 text-muted">الكمية: ${item.quantity}</p>
                                                                <p class="mb-0 text-muted">المجموع: ${(item.price * item.quantity).toLocaleString()} ج.م</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <h6 class="mb-2">تحديث حالة الطلب</h6>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-primary" onclick="updateOrderStatus('${order.id}', 'processing')">
                                            <i class="bi bi-gear"></i> معالجة
                                        </button>
                                        <button class="btn btn-sm btn-success" onclick="updateOrderStatus('${order.id}', 'completed')">
                                            <i class="bi bi-check-circle"></i> إكمال
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="updateOrderStatus('${order.id}', 'cancelled')">
                                            <i class="bi bi-x-circle"></i> إلغاء
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        ordersList.appendChild(orderDiv);
                    } catch (error) {
                        console.error('خطأ في معالجة الطلب:', error);
                    }
                });

                // تحديث الإحصائيات
                document.getElementById('totalOrders').textContent = totalOrders;
                document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString();
                document.getElementById('totalCustomers').textContent = customers.size;
            }, (error) => {
                console.error('خطأ في تحميل الطلبات:', error);
                const ordersList = document.getElementById('ordersList');
                ordersList.innerHTML = '<div class="alert alert-danger">حدث خطأ في تحميل الطلبات. يرجى المحاولة مرة أخرى.</div>';
            });
        }

        // تحديث حالة الطلب
        function updateOrderStatus(orderId, newStatus) {
            const statusMap = {
                'processing': 'قيد المعالجة',
                'completed': 'مكتمل',
                'cancelled': 'ملغي'
            };

            ordersRef.child(orderId).update({
                status: statusMap[newStatus],
                updatedAt: new Date().toISOString()
            })
            .then(() => {
                // إظهار رسالة نجاح باستخدام Bootstrap Toast
                const toast = document.createElement('div');
                toast.className = 'toast align-items-center text-white bg-success border-0';
                toast.setAttribute('role', 'alert');
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            تم تحديث حالة الطلب بنجاح
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                `;
                
                let toastContainer = document.querySelector('.toast-container');
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                    document.body.appendChild(toastContainer);
                }
                
                toastContainer.appendChild(toast);
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
                setTimeout(() => toast.remove(), 3000);
            })
            .catch(error => {
                console.error('خطأ في تحديث حالة الطلب:', error);
                alert('حدث خطأ أثناء تحديث حالة الطلب');
            });
        }

        // إضافة وظيفة البحث
        document.querySelector('.search-box input').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const orders = document.querySelectorAll('.order-card');
            
            orders.forEach(order => {
                const orderText = order.textContent.toLowerCase();
                if (orderText.includes(searchTerm)) {
                    order.style.display = '';
                } else {
                    order.style.display = 'none';
                }
            });
        });

        // إضافة وظيفة التصفية
        document.querySelectorAll('.filter-buttons .btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // إزالة الفئة النشطة من جميع الأزرار
                document.querySelectorAll('.filter-buttons .btn').forEach(b => b.classList.remove('active'));
                // إضافة الفئة النشطة للزر المحدد
                this.classList.add('active');
                
                const status = this.textContent.trim();
                const orders = document.querySelectorAll('.order-card');
                
                orders.forEach(order => {
                    const orderStatus = order.querySelector('.status-badge').textContent.trim();
                    if (status === 'الكل' || orderStatus === status) {
                        order.style.display = '';
                    } else {
                        order.style.display = 'none';
                    }
                });
            });
        });

        // تحميل الطلبات عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', loadOrders);

        // دالة عرض الطلبات
        function displayOrders(orders) {
            const ordersList = document.getElementById('ordersList');
            ordersList.innerHTML = '';

            if (!orders || Object.keys(orders).length === 0) {
                ordersList.innerHTML = '<div class="alert alert-info">لا توجد طلبات حتى الآن</div>';
                return;
            }

            Object.entries(orders).forEach(([id, order]) => {
                const orderCard = document.createElement('div');
                orderCard.className = 'card mb-3';
                orderCard.innerHTML = `
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h5 class="card-title">طلب #${id.substring(0, 8)}</h5>
                                <p class="card-text">
                                    <strong>العميل:</strong> ${order.customerName}<br>
                                    <strong>رقم الهاتف:</strong> ${order.customerPhone}<br>
                                    <strong>العنوان:</strong> ${order.customerAddress}<br>
                                    <strong>التاريخ:</strong> ${new Date(order.orderDate).toLocaleString('ar-EG')}
                                </p>
                                <div class="order-items mt-3">
                                    <h6>المنتجات:</h6>
                                    <div class="row">
                                        ${Object.entries(order.items).map(([itemId, item]) => `
                                            <div class="col-md-6 mb-3">
                                                <div class="d-flex align-items-center">
                                                    <img src="${item.image}" class="product-img me-3" alt="${item.name}">
                                                    <div>
                                                        <h6 class="mb-1">${item.name}</h6>
                                                        <p class="mb-1">السعر: ${item.price} ج.م</p>
                                                        <p class="mb-0">الكمية: ${item.quantity}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ${order.customerNote ? `<p class="mt-3"><strong>ملاحظات العميل:</strong> ${order.customerNote}</p>` : ''}
                            </div>
                            <div class="col-md-4">
                                <div class="order-summary">
                                    <h6>ملخص الطلب:</h6>
                                    <p class="mb-1">المجموع: ${order.totalAmount.toLocaleString()} ج.م</p>
                                    ${order.discountAmount > 0 ? `
                                        <p class="mb-1">الخصم: ${order.discountAmount.toLocaleString()} ج.م</p>
                                        <p class="mb-1">كود الخصم: ${order.discountCode}</p>
                                    ` : ''}
                                    <p class="mb-3">المجموع النهائي: ${(order.totalAmount - order.discountAmount).toLocaleString()} ج.م</p>
                                </div>
                                <div class="order-status">
                                    <h6>حالة الطلب:</h6>
                                    <div class="btn-group w-100">
                                        <button class="btn ${order.status === 'جديد' ? 'btn-primary' : 'btn-outline-primary'}" 
                                                onclick="updateOrderStatus('${id}', 'جديد')">جديد</button>
                                        <button class="btn ${order.status === 'قيد المعالجة' ? 'btn-warning' : 'btn-outline-warning'}" 
                                                onclick="updateOrderStatus('${id}', 'قيد المعالجة')">قيد المعالجة</button>
                                        <button class="btn ${order.status === 'مكتمل' ? 'btn-success' : 'btn-outline-success'}" 
                                                onclick="updateOrderStatus('${id}', 'مكتمل')">مكتمل</button>
                                        <button class="btn ${order.status === 'ملغي' ? 'btn-danger' : 'btn-outline-danger'}" 
                                                onclick="updateOrderStatus('${id}', 'ملغي')">ملغي</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                ordersList.appendChild(orderCard);
            });
        }
    </script>
</body>
</html> 